Contexte du projet

App mono-fichier principale : index.html (Tailwind, moment, moment-hijri déjà chargés).

La section Focus vit dans #daily-focus-section avec :

un titre,

#daily-focus-time (ligne “Maintenant (…)”),

#daily-focus-content (contenu),

#weekly-special-focus (encarts du jour).

Les horaires de prière sont déjà calculés par fetchAndDisplayPrayerTimes() et on sait produire un tableau prayerSchedule (Fajr, Sunrise/Shuruq, Dhuhr, Asr, Maghrib, Isha, format HH:mm).

Objectif

Refaire Focus du Jour pour qu’il soit :

dynamique par tranches horaires,

contextuel Retraite vs Planning Annuel,

enrichi des rappels hebdomadaires + zikrs perso exacts,

lisible et élégant (badge de mode, bullets),

fiable (tick 1 fois / min, sans fuites d’intervalles).

IMPORTANT : ne rien casser ailleurs (Journal, Lectures, Qibla, Charts…). Tout se fait dans index.html (JS + un soupçon de CSS) ou, si tu préfères, dans un petit module focus.js que tu importes en <script type="module">.

1) Données & règles métier
1.1. Tranches horaires quotidiennes (planning “annuel” de base)
On reste exactement sur ces libellés et fourchettes (24h) ; les tranches qui traversent minuit doivent fonctionner.

js
Copier
Modifier
const DAILY_SLOTS = [
  { start: "03:00", end: "04:30",  name: "Dernier tiers de la nuit",  acts: ["Tahajjud (2–8 rakʿāt)", "Duʿā’ sincère", "Dhikr profond"] },
  { start: "04:30", end: "05:00",  name: "Prière du Fajr",            acts: ["Ṣalāt al-Faǧr", "Recueillement"] },
  { start: "05:00", end: "07:00",  name: "Après al-faǧr",             acts: ["Adhkār du matin", "Lecture/mémorisation du Coran", "Méditation"] },
  { start: "08:00", end: "10:00",  name: "Milieu de la matinée",      acts: ["Ṣalāt ad-Ḍuḥā (2–8 rakʿāt)", "Étude du Coran ou des ḥadiths"] },
  { start: "10:00", end: "12:30",  name: "Journée",                    acts: ["Travaux personnels", "Œuvres caritatives / service"] },
  { start: "12:30", end: "13:30",  name: "Prière du Dhuhr",           acts: ["Ṣalāt aẓ-Ẓuhr", "Dhikr", "Relecture"] },
  { start: "14:00", end: "15:30",  name: "Après-midi",                acts: ["Lecture spirituelle", "Étude des maîtres soufis", "Repos"] },
  { start: "15:30", end: "16:30",  name: "Prière de l’Asr",           acts: ["Ṣalāt al-ʿAṣr", "Dhikr", "Marche méditative"] },
  { start: "17:00", end: "19:00",  name: "Après al-Maghrib",          acts: ["Ṣalāt al-Maghrib", "Dhikr", "Salawat sur le Prophète"] },
  { start: "20:00", end: "21:30",  name: "Après al-ʿIshāʾ",           acts: ["Ṣalāt al-ʿIshāʾ", "Dhikr collectif", "Litanies"] },
  { start: "21:30", end: "03:00",  name: "Soir & nuit",               acts: ["Étude (tafsīr, fiqh, ḥikam)", "Repos", "Protection nocturne (Āyat al-Kursī, sourates protectrices)"] },
];
Bonus optionnel : si prayerSchedule est disponible, tu peux remplacer quelques bornes “fixes” (Fajr, Dhuhr, Asr, Maghrib, Isha) par ces heures afin d’ajuster dynamiquement. Sinon, on garde les bornes ci-dessus.

1.2. Mode Retraite (4 semaines)
La date de début est stockée dans localStorage['retreat_start'] (ISO, ex. 2025-08-01).

Retraite active si now ∈ [retreat_start, retreat_start + 28 jours[.

Semaine = floor(diffJours / 7) + 1 (1 → 4).

Badge à afficher : Mode Retraite — Semaine X.

En mode Retraite, on ajoute le thème hebdomadaire aux actes du slot courant :

js
Copier
Modifier
const RETREAT_THEMES = {
  1: { title: "Semaine 1 : Purification & discipline",    extra: ["Repentir sincère (istighfār réfléchi)", "Jeûne (lundi/jeudi)", "Journal de progrès"] },
  2: { title: "Semaine 2 : Connaissance & dhikr",         extra: ["Tafsīr / ḥadīths / ḥikam", "Dhikr collectif (apprentissage des litanies)", "Abondance de salawāt"] },
  3: { title: "Semaine 3 : Service & morale",             extra: ["Œuvres caritatives", "Jeûne des jours blancs (13–15)", "Patience & gratitude"] },
  4: { title: "Semaine 4 : Consolidation & protection",   extra: ["Prière de minuit prolongée", "Ruqyah / protections", "Retraite intérieure (khalwa)"] },
};
Hors Retraite : badge Planning Annuel.

1.3. Rappels hebdomadaires & zikrs personnels (définitifs)
À ajouter (jamais remplacer) sous forme de petits encarts “du jour” :

Tous les jours : 1261× Istighfār.

Mercredi nuit : 450× Ḥasbunallāh wa niʿmal-wakīl
Fenêtre : de Maghrib (mercredi) à Fajr (jeudi) ; si pas d’API d’horaires, de 19:00 à 04:30 par défaut.

Vendredi : 313× Ṣalāt sur le Prophète (toute la journée) et duʿāʾ pour les défunts après chaque prière du vendredi.
Affiche les deux rappels.

Jours blancs hijri (13–15) : “Jeûne recommandé (jours blancs)”.

Lundi/Jeudi : bannière “Jour propice au jeûne surérogatoire”.

2) Affichage & UX
Dans #daily-focus-time : Maintenant (${slot.name}).

Dans #daily-focus-content : une liste à puces (Tailwind) :

actes du slot courant (DAILY_SLOTS),

le thème / extras Retraite si actif,

les rappels hebdo & zikrs perso applicables aujourd’hui/maintenant.

Au coin droit du bloc, un badge de mode :

Planning Annuel ou Mode Retraite — Semaine X.

Dans #weekly-special-focus : cartes d’alerte (couleurs Tailwind) pour :

Lundi/Jeudi (jeûne),

Vendredi (Kahf + salawāt + duʿāʾ défunt après chaque prière),

Jours blancs (13–15 hijri).

Tick : mets à jour chaque minute (setInterval 60 000 ms) + au chargement immédiat. Nettoie l’intervalle si besoin (pas de fuite).

Langue : tout en français, garde les termes clés arabes (Ṣalāt, Dhikr, etc.) comme dans l’ancien index.

Accessibilité : bullets, contrastes, pas de texte minuscule.

3) Implémentation (code précis)
CSS minimal pour le badge (dans <style> de index.html) :

css
Copier
Modifier
.mode-badge{position:absolute;top:0.75rem;right:0.75rem}
HTML : le conteneur Focus existe déjà. Ajoute dans #daily-focus-section un badge vide :

html
Copier
Modifier
<div id="focus-mode-badge" class="mode-badge hidden">
  <span class="inline-block rounded-full bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-semibold"></span>
</div>
JS (dans DOMContentLoaded) : ajoute un module/isoler les fonctions suivantes (ou mets-les à côté de l’existant) :

js
Copier
Modifier
function inOvernightWindow(nowHHmm, a, b){
  // true si le créneau a->b passe minuit (ex. 21:30 → 03:00)
  return (a > b) ? (nowHHmm >= a || nowHHmm < b) : (nowHHmm >= a && nowHHmm < b);
}

function getCurrentSlot(now, slots){
  const hhmm = now.format("HH:mm");
  for(const s of slots){
    if (inOvernightWindow(hhmm, s.start, s.end)) return s;
  }
  return slots[0]; // fallback
}

function isRetreatActive(now){
  const start = localStorage.getItem("retreat_start");
  if(!start) return {active:false};
  const s = moment(start, "YYYY-MM-DD");
  const diff = now.diff(s, "days");
  if (diff >= 0 && diff < 28){
    const week = Math.floor(diff / 7) + 1;
    return {active:true, week, theme: RETREAT_THEMES[week]};
  }
  return {active:false};
}

function weeklyFlags(now, prayerSchedule){
  const d = now.day(); // 0=dim..5=ven..3=mer
  const hijriDay = now.iDate();
  const flags = { fasting:false, friday:false, whiteDays:false, wedNight:false };
  // lundi(1) ou jeudi(4)
  if (d === 1 || d === 4) flags.fasting = true;
  if (d === 5) flags.friday = true;

  if (hijriDay >= 13 && hijriDay <= 15) flags.whiteDays = true;

  // Mercredi nuit → de Maghrib(mer) à Fajr(jeu)
  const hhmm = now.format("HH:mm");
  if (d === 3){ // mercredi après Maghrib
    const maghrib = (prayerSchedule?.find(p=>p.id==='maghrib')?.time) || "19:00";
    if (hhmm >= maghrib) flags.wedNight = true;
  }
  if (d === 4){ // jeudi avant Fajr
    const fajr = (prayerSchedule?.find(p=>p.id==='fajr')?.time) || "04:30";
    if (hhmm < fajr) flags.wedNight = true;
  }
  return flags;
}

let focusInterval = null;

async function renderFocus(prayerSchedule){
  const now = moment();
  const slot = getCurrentSlot(now, DAILY_SLOTS);
  const {active, week, theme} = isRetreatActive(now);
  const flags = weeklyFlags(now, prayerSchedule);

  // Ligne “Maintenant (…)”
  document.getElementById('daily-focus-time').textContent = `Maintenant (${slot.name})`;

  // Badge
  const badge = document.querySelector('#focus-mode-badge');
  const badgeSpan = badge.querySelector('span');
  if(active){
    badge.classList.remove('hidden');
    badgeSpan.textContent = `Mode Retraite — Semaine ${week}`;
  }else{
    badge.classList.remove('hidden');
    badgeSpan.textContent = `Planning Annuel`;
  }

  // Bullets du panneau principal
  const bullets = [];
  slot.acts.forEach(a => bullets.push(a));

  if(active && theme){
    bullets.push(`— ${theme.title}`);
    theme.extra.forEach(x => bullets.push(x));
  }

  // Zikrs persos & rappels (toujours en AJOUT)
  bullets.push("1261× Istighfār (quotidien)");

  if(flags.wedNight){
    bullets.push("450× Ḥasbunallāh wa niʿmal-wakīl (nuit du mercredi)");
  }
  if(flags.friday){
    bullets.push("313× Ṣalāt sur le Prophète (vendredi)");
    bullets.push("Duʿāʾ pour les défunts après chaque prière du vendredi");
  }
  if(flags.whiteDays){
    bullets.push("Jeûne recommandé : jours blancs (13–15 hijri)");
  }

  document.getElementById('daily-focus-content').innerHTML =
    `<ul class="text-left max-w-3xl mx-auto list-disc list-inside space-y-2">
      ${bullets.map(b=>`<li>${b}</li>`).join("")}
     </ul>`;

  // Encarts “du jour”
  const cards = [];
  if(flags.fasting){
    cards.push({color:'blue', title:"Rappel du jour", body:"Lundi/Jeudi : jour propice au jeûne surérogatoire."});
  }
  if(flags.friday){
    cards.push({color:'green', title:"Rappel du Vendredi", body:"Lire la sourate Al-Kahf, multiplier les salawāt, et faire le duʿāʾ pour les défunts après chaque prière."});
  }
  if(flags.whiteDays){
    cards.push({color:'yellow', title:"Jours Blancs", body:`Nous sommes dans les jours blancs (hijri ${now.iDate()}) : jeûne recommandé.`});
  }
  document.getElementById('weekly-special-focus').innerHTML =
    cards.map(c => `
      <div class="mt-4 rounded-lg border-l-4 p-4 bg-${c.color}-50 border-${c.color}-400 text-${c.color}-700">
        <p class="font-bold">${c.title}</p><p>${c.body}</p>
      </div>`).join("");
}

function startFocus(prayerSchedule){
  if (focusInterval) clearInterval(focusInterval);
  renderFocus(prayerSchedule);
  focusInterval = setInterval(()=>renderFocus(prayerSchedule), 60_000);
}
Intégration :

Quand fetchAndDisplayPrayerTimes() termine de construire prayerSchedule, appelle startFocus(prayerSchedule).

Si l’API d’horaires échoue, appelle startFocus(null) (fallback sur heures fixes).

4) Tests d’acceptation (doit passer)
Retraite inactive (pas de retreat_start) → badge “Planning Annuel”.

Retraite active (retreat_start = aujourd’hui − 9 jours) → badge “Mode Retraite — Semaine 2” et puces supplémentaires de la semaine 2.

Lundi 10:30 → encart “jeûne surérogatoire”.

Mercredi 20:30 → Jeudi 04:00 → puce “450× Ḥasbunallāh…”.

Vendredi 11:00 → puces “313× Ṣalāt…” et “Duʿāʾ pour les défunts…”.

Hijri 13–15 → encart “Jours blancs”.

La ligne Maintenant ( … ) suit bien les tranches ; rafraîchit au max 1 fois / min ; pas de duplication d’encarts ni de fuite d’intervalles.

Merci d’appliquer ces changements proprement, sans régression sur les autres onglets.

