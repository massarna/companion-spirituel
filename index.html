<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compagnon Spirituel</title>

    <!-- Styles & Librairies externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/fr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.1.2/moment-hijri.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Polices & PWA -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Lato:wght@300;400;700&family=Orbitron:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#fdfaf6" />

    <!-- CSS uniquement -->
    <style>
      :root {
        --bg: #fdfaf6;
        --card: #ffffff;
        --ink: #3b2f2f;
        --muted: #a58f86;
        --brand: #ea5b3c;
        --ring: #10b981;
      }
      html,
      body {
        height: 100%;
        background: var(--bg);
        font-family:
          "Lato",
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          "Helvetica Neue",
          Arial,
          "Noto Sans",
          "Liberation Sans",
          sans-serif;
      }
      .title {
        font-family: "Amiri", serif;
      }
      .clock {
        font-family: "Orbitron", monospace;
        letter-spacing: 0.06em;
      }
      .card {
        background: var(--card);
        border-radius: 22px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
        padding: 1.25rem;
      }
      .tab-btn[aria-selected="true"] {
        background: #fff;
        color: #0f172a;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      }
      .badge {
        background: #eef2ff;
        color: #3730a3;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 700;
      }
      .qibla-rose {
        width: 220px;
        height: 220px;
        border-radius: 50%;
        border: 8px solid #e5e7eb;
        position: relative;
        margin: auto;
      }
      .qibla-rose::after {
        content: "N";
        position: absolute;
        top: -28px;
        left: 50%;
        transform: translateX(-50%);
        color: #6b7280;
        font-weight: 700;
      }
      .qibla-arrow {
        position: absolute;
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 80px solid var(--ring);
        left: 50%;
        top: 50%;
        transform-origin: 50% 90%;
        transform: translate(-50%, -80%) rotate(0deg);
        filter: drop-shadow(0 6px 10px rgba(16, 185, 129, 0.35));
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>

  <body class="text-slate-800">
    <!-- Header -->
    <header class="max-w-5xl mx-auto px-4 py-10">
      <h1 class="title text-center text-5xl sm:text-6xl text-slate-800">
        Compagnon Spirituel
      </h1>
      <p class="text-center text-[var(--brand)] mt-2">
        Votre guide spirituel quotidien
      </p>

      <!-- Horloge & Dates -->
      <div class="mt-8 card max-w-xl mx-auto text-center">
        <div id="clock" class="clock text-5xl sm:text-6xl text-slate-700">
          --:--:--
        </div>
        <div class="mt-5">
          <div id="date-greg" class="font-semibold text-sky-600">‚Äî</div>
          <div id="date-hijri" class="text-slate-500">‚Äî</div>
        </div>
        <div class="mt-4">
          <span id="mode-badge" class="badge">Planning Annuel</span>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="sticky top-0 z-20 bg-[var(--bg)] border-y border-slate-200/70">
      <div class="max-w-5xl mx-auto px-4">
        <ul class="flex flex-wrap gap-2 sm:gap-3 py-3">
          <!-- 7 onglets -->
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="accueil"
              aria-selected="true"
            >
              Accueil
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="programme"
            >
              Programme
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="lectures"
            >
              Lectures
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="retraite"
            >
              Retraite
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="journal"
            >
              Journal
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="mois"
            >
              Mois
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="qibla"
            >
              Qibla
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Pages -->
    <main class="max-w-5xl mx-auto px-4 py-8 space-y-10">
      <!-- Accueil -->
      <section data-page="accueil">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Prochaine pri√®re -->
          <div class="card">
            <h2 class="title text-2xl mb-3">Prochaine pri√®re</h2>
            <div class="flex items-center gap-4">
              <div>
                <div class="text-sm text-slate-500">Ville : Bobo-Dioulasso</div>
                <div class="mt-1 text-lg font-semibold">
                  <span id="next-prayer-name">‚Äî</span> dans
                  <span id="next-prayer-eta">--:--:--</span>
                </div>
              </div>
            </div>
            <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
              <div class="p-3 rounded-xl border" id="p-Fajr">
                Fajr : <b id="t-Fajr">‚Äî</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Shuruq">
                Shuruq : <b id="t-Shuruq">‚Äî</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Dhuhr">
                Dhuhr : <b id="t-Dhuhr">‚Äî</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Asr">
                Asr : <b id="t-Asr">‚Äî</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Maghrib">
                Maghrib : <b id="t-Maghrib">‚Äî</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Isha">
                Isha : <b id="t-Isha">‚Äî</b>
              </div>
            </div>
          </div>

          <!-- Graphiques -->
          <div class="card">
            <h2 class="title text-2xl mb-3">Suivi hebdomadaire</h2>
            <div class="grid grid-cols-1 gap-6">
              <canvas
                id="chart-rakaa"
                height="150"
                class="bg-white rounded-xl"
              ></canvas>
              <canvas
                id="chart-zikr"
                height="150"
                class="bg-white rounded-xl"
              ></canvas>
            </div>
          </div>
        </div>

        <!-- Focus du jour -->
        <div class="mt-6 card">
          <h3 class="text-lg font-semibold mb-3">Focus du jour</h3>
          <div id="focus-list" class="space-y-2">
            <!-- Contenu g√©n√©r√© dynamiquement -->
          </div>
        </div>
      </section>

      <!-- Programme -->
      <section data-page="programme" class="hidden">
        <div class="space-y-8">
          <!-- Programme D√©taill√© Jour par Jour -->
          <div class="card">
            <h2 class="title text-2xl mb-4">Programme D√©taill√© Jour par Jour</h2>
            <div id="prog-week" class="grid md:grid-cols-2 gap-4">
              <!-- Contenu g√©n√©r√© dynamiquement -->
            </div>
          </div>

          <!-- Mes Zikrs Personnalis√©s -->
          <div class="card">
            <h2 class="title text-2xl mb-4">Mes Zikrs Personnalis√©s</h2>
            <div id="prog-zikrs" class="grid sm:grid-cols-2 gap-4">
              <!-- Contenu g√©n√©r√© dynamiquement -->
            </div>
          </div>

          <!-- Formules de Zikr √† R√©citer -->
          <div class="card">
            <h2 class="title text-2xl mb-4">Formules de Zikr √† R√©citer</h2>
            <div id="prog-formules" class="space-y-6">
              <!-- Contenu g√©n√©r√© dynamiquement -->
            </div>
          </div>
        </div>
      </section>

      <!-- Lectures -->
      <section data-page="lectures" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-4">Lectures</h2>
          <div class="flex gap-2 mb-4">
            <button
              class="px-3 py-1.5 rounded-lg border"
              data-lect="kahf"
              aria-pressed="true"
            >
              Sourate Al-Kahf
            </button>
            <button class="px-3 py-1.5 rounded-lg border" data-lect="special">
              Lecture sp√©ciale quotidienne
            </button>
          </div>
          <div id="lect-content" class="prose max-w-none text-[17px] leading-8">
            Choisis une lecture.
          </div>
        </div>
      </section>

      <!-- Retraite -->
      <section data-page="retraite" class="hidden">
        <div class="space-y-8">
          <!-- Configuration de la Retraite -->
          <div class="card">
            <h2 class="title text-2xl mb-3">Configuration de la Retraite</h2>
            <label class="block text-sm text-slate-600 mb-1"
              >Date de d√©but (4 semaines)</label
            >
            <input
              id="retreat-start"
              type="date"
              class="border rounded-lg px-3 py-2"
            />
            <button
              id="retreat-save"
              class="ml-2 px-3 py-2 rounded-lg bg-emerald-600 text-white"
            >
              Enregistrer
            </button>
            <div id="retreat-msg" class="mt-3 text-slate-600">‚Äî</div>
          </div>

          <!-- Grille Quotidienne -->
          <div class="card">
            <h2 class="title text-2xl mb-4">Grille Quotidienne de Retraite</h2>
            <div id="retreat-grid" class="overflow-x-auto">
              <!-- Contenu g√©n√©r√© dynamiquement -->
            </div>
          </div>

          <!-- Accents par Semaine -->
          <div class="card">
            <h2 class="title text-2xl mb-4">Accents Th√©matiques par Semaine</h2>
            <div id="retreat-weeks" class="grid lg:grid-cols-2 xl:grid-cols-4 gap-4">
              <!-- Contenu g√©n√©r√© dynamiquement -->
            </div>
          </div>

          <!-- Planning Annuel All√©g√© -->
          <div class="card">
            <h2 class="title text-2xl mb-4">Planning Annuel All√©g√©</h2>
            <div id="retreat-annual">
              <!-- Contenu g√©n√©r√© dynamiquement -->
            </div>
          </div>
        </div>
      </section>

      <!-- Journal -->
      <section data-page="journal" class="hidden">
        <div class="space-y-8" id="journal-container">
          <div class="card">
            <h2 class="title text-2xl mb-4">Journal quotidien</h2>
            <div class="grid sm:grid-cols-2 gap-6">
              <div>
                <h3 class="font-semibold mb-2">Pri√®res</h3>
                <div class="space-y-2">
                  <label class="flex items-center gap-2"
                    ><input type="checkbox" class="jp" value="Fajr" /> Fajr</label
                  >
                  <label class="flex items-center gap-2"
                    ><input type="checkbox" class="jp" value="Dhuhr" />
                    Dhuhr</label
                  >
                  <label class="flex items-center gap-2"
                    ><input type="checkbox" class="jp" value="Asr" /> Asr</label
                  >
                  <label class="flex items-center gap-2"
                    ><input type="checkbox" class="jp" value="Maghrib" />
                    Maghrib</label
                  >
                  <label class="flex items-center gap-2"
                    ><input type="checkbox" class="jp" value="Isha" /> Isha</label
                  >
                </div>

                <h3 class="font-semibold mt-6 mb-2">Tasbih</h3>
                <div class="flex items-center gap-3">
                  <button id="tasbih-minus" class="px-3 py-2 rounded-lg border">
                    -1
                  </button>
                  <div
                    id="tasbih-count"
                    class="min-w-[3ch] text-center font-semibold"
                  >
                    0
                  </div>
                  <button id="tasbih-plus" class="px-3 py-2 rounded-lg border">
                    +1
                  </button>
                </div>
              </div>

              <div>
                <h3 class="font-semibold mb-2">Notes personnelles</h3>
                <textarea
                  id="note"
                  rows="7"
                  class="w-full rounded-lg border p-3"
                  placeholder="√âcris ici ce que ton c≈ìur a retenu aujourd‚Äôhui‚Ä¶"
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Mois -->
      <section data-page="mois" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-3">Mois h√©girien en cours</h2>
          <div id="mois-info" class="text-slate-600">
            Nom, sens, pratiques recommand√©es‚Ä¶ (structure pr√™te)
          </div>
        </div>
      </section>

      <!-- Qibla -->
      <section data-page="qibla" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-4">Direction de la Qibla</h2>
          <div class="qibla-rose">
            <div id="qibla-arrow" class="qibla-arrow" aria-hidden="true"></div>
            <span class="sr-only" id="qibla-angle-label"></span>
          </div>
          <div class="mt-4 flex items-center gap-3">
            <button
              id="btn-geo"
              class="px-3 py-2 rounded-lg bg-slate-800 text-white"
            >
              Utiliser ma position
            </button>
            <div id="qibla-text" class="text-slate-600">
              Par d√©faut : Bobo-Dioulasso
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-12 pb-10 text-center text-slate-500">
      Compagnon spirituel pour faciliter la pratique quotidienne.
    </footer>

    <!-- 1) Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("sw.js").catch(console.error);
        });
      }
    </script>

    <!-- 2) Bridge: expose window.storageAPI (via bridge.js) -->
    <script type="module" src="./bridge.js"></script>

    <!-- 3) App Controller (horloge, onglets, pri√®res, charts, qibla) -->
    <script type="module">
      // --- Fallback localStorage ---
      if (!window.storageAPI) {
        window.storageAPI = {
          storageGet: async (key, defVal) => {
            try { const v = localStorage.getItem(key); return v == null ? defVal : JSON.parse(v); }
            catch { return defVal; }
          },
          storageSet: async (key, val) => { localStorage.setItem(key, JSON.stringify(val)); return true; },
          storageRemove: async (key) => { localStorage.removeItem(key); return true; },
          storageSubscribe: (key, cb) => {
            const h = (e) => { if (e.key === key) cb(e.newValue ? JSON.parse(e.newValue) : null); };
            window.addEventListener('storage', h); return () => window.removeEventListener('storage', h);
          }
        };
        console.log('[Compagnon] fallback storage ready');
      }
      // -----------------------------

      // util
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => [...r.querySelectorAll(s)];

      // Horloge & Dates
      moment.locale("fr");
      function tickClock() {
        const now = moment();
        $("#clock").textContent = now.format("HH:mm:ss");
        $("#date-greg").textContent = now.format("dddd D MMMM YYYY");
        const hijri = now.clone().format("iD iMMMM iYYYY"); // moment-hijri
        $("#date-hijri").textContent = hijri;
      }
      tickClock();
      setInterval(tickClock, 1000);

      // Onglets
      const pages = $$("section[data-page]");
      const btns = $$(".tab-btn");
      function show(tab) {
        pages.forEach((p) =>
          p.classList.toggle("hidden", p.dataset.page !== tab),
        );
        btns.forEach((b) =>
          b.setAttribute("aria-selected", String(b.dataset.tab === tab)),
        );
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
      btns.forEach((b) =>
        b.addEventListener("click", () => show(b.dataset.tab)),
      );
      show("accueil");

      // Mode (badge) et retraite - logique compl√®te
      async function refreshRetreat() {
        const api = window.storageAPI;
        if (!api) return;

        const startDate = await api.storageGet("retreatStart", null);
        if (!startDate) {
          $("#mode-badge").textContent = "Planning Annuel";
          $("#retreat-msg").textContent = "Aucune retraite configur√©e.";
          return;
        }

        const start = moment(startDate);
        const today = moment();
        const diffWeeks = today.diff(start, "weeks");
        const currentWeek = diffWeeks + 1;
        const endDate = start.clone().add(28, "days");

        // Mise √† jour du badge
        if (currentWeek > 4 || today.isAfter(endDate)) {
          $("#mode-badge").textContent = "Planning Annuel";
          $("#retreat-msg").textContent = `Retraite termin√©e (${start.format("DD/MM/YYYY")} ‚Üí ${endDate.format("DD/MM/YYYY")})`;
        } else {
          $("#mode-badge").textContent = `Mode Retraite ‚Äì Semaine ${Math.max(1, Math.min(currentWeek, 4))}`;
          $("#retreat-msg").textContent = `Retraite en cours : ${start.format("DD/MM/YYYY")} ‚Üí ${endDate.format("DD/MM/YYYY")} (Semaine ${Math.max(1, Math.min(currentWeek, 4))}/4)`;
        }
      }

      // Focus du jour - mise √† jour dynamique
      async function updateFocusDuJour() {
        const api = window.storageAPI;
        if (!api) return;

        const now = moment();
        const today = now.format("YYYY-MM-DD");
        const tasks = todayTasks(now);
        const focusContainer = $("#focus-list");

        if (!focusContainer) return;

        let html = '';

        for (const task of tasks) {
          const done = await isDone(task.key, today);
          html += `
            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50">
              <input type="checkbox" class="form-checkbox" data-key="${task.key}" ${done ? 'checked' : ''}>
              <div class="flex-1">
                <div class="font-medium text-sm">${task.label}</div>
                <div class="text-xs text-slate-500">${task.when}</div>
              </div>
            </label>
          `;
        }

        if (tasks.length === 0) {
          html = '<p class="text-sm text-slate-500 text-center py-2">Aucun zikr sp√©cifique aujourd\'hui</p>';
        }

        focusContainer.innerHTML = html;

        // Event listeners pour les cases
        focusContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', async () => {
            const key = checkbox.dataset.key;
            if (checkbox.checked) {
              await markDone(key, today);
            } else {
              await api.storageSet(`zikrDone:${today}:${key}`, false);
            }
          });
        });
      }

      // Charger la date sauvegard√©e dans l'input
      async function loadRetreatDate() {
        const api = window.storageAPI;
        if (!api) return;

        const savedDate = await api.storageGet("retreatStart", null);
        if (savedDate) {
          $("#retreat-start").value = savedDate;
        }
      }

      // Initialiser la retraite
      await refreshRetreat();
      await loadRetreatDate();

      // Retraite: sauvegarder date
      $("#retreat-save").addEventListener("click", async () => {
        const dateValue = $("#retreat-start").value;
        if (!dateValue) {
          $("#retreat-msg").textContent = "Veuillez s√©lectionner une date de d√©but.";
          return;
        }

        const api = window.storageAPI;
        if (!api) return;

        await api.storageSet("retreatStart", dateValue);
        await refreshRetreat();
      });

      // Horaires de pri√®re (Bobo-Dioulasso ‚Äì placeholders statiques pour la d√©mo)
      const PRAYERS = [
        { name: "Fajr", time: "05:00" },
        { name: "Shuruq", time: "06:15" },
        { name: "Dhuhr", time: "12:30" },
        { name: "Asr", time: "15:45" },
        { name: "Maghrib", time: "18:30" },
        { name: "Isha", time: "19:45" },
      ];
      for (const p of PRAYERS) {
        $("#t-" + p.name).textContent = p.time;
      }
      console.log('Chart version:', window.Chart?.version);

      // Charts - cr√©√©s UNE seule fois
      const ctxRakaa = document.getElementById("chart-rakaa")?.getContext("2d");
      const ctxZikr = document.getElementById("chart-zikr")?.getContext("2d");

      if (window.Chart && ctxRakaa && ctxZikr) {
        new Chart(ctxRakaa, {
          type: "bar",
          data: {
            labels: ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"],
            datasets: [
              { label: "Rak ø√¢t (jour+nuit)", data: [6, 8, 10, 4, 12, 8, 6] },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });

        new Chart(ctxZikr, {
          type: "doughnut",
          data: {
            labels: ["Tawhid", "Istighfar", "Sal√¢t  øala n-Nab√Æ", "Autres"],
            datasets: [{ data: [40, 30, 20, 10] }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "60%",
          },
        });
      } else {
        console.warn("Chart.js non charg√© ou canvas introuvable.");
      }

      // Helper pour cr√©er une date "aujourd'hui" √† partir de HH:mm
      function todayAt(hhmm) {
        const [H, M] = hhmm.split(":").map(Number);
        return moment().clone().hours(H).minutes(M).seconds(0).milliseconds(0);
      }

      function nextPrayer() {
        const now = moment();
        for (const p of PRAYERS) {
          const t = todayAt(p.time);
          if (now.isBefore(t)) return { p, t };
        }
        return { p: PRAYERS[0], t: todayAt(PRAYERS[0].time).add(1, 'day') };
      }

      function updateCountdown() {
        const { p, t } = nextPrayer();
        $("#next-prayer-name").textContent = p.name;

        const diff = moment.duration(t.diff(moment()));
        const hh = String(Math.floor(diff.asHours())).padStart(2, "0");
        const mm = String(diff.minutes()).padStart(2, "0");
        const ss = String(diff.seconds()).padStart(2, "0");
        $("#next-prayer-eta").textContent = `${hh}:${mm}:${ss}`;

        // surbrillance
        PRAYERS.forEach((x) => {
          const el = $("#p-" + x.name);
          el.classList.toggle("ring", x.name === p.name);
          el.classList.toggle("ring-emerald-500", x.name === p.name);
          el.classList.toggle("ring-offset-2", x.name === p.name);
        });
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);

      // Journal - fonctions utilitaires et d'initialisation
      let count = 0;
      let journalInitialized = false;

      function isFriday(date) {
        return date.day() === 5; // 0 = Lundi, 5 = Vendredi
      }

      async function loadJournalData() {
        const api = window.storageAPI;
        if (!api) return;

        try {
          const today = moment().format("YYYY-MM-DD");

          // Charger le compteur tasbih
          const $count = $("#tasbih-count");
          if ($count) {
            count = await api.storageGet("tasbihCount", 0);
            $count.textContent = count;
          }

          // Charger les cases de pri√®res
          const jpCheckboxes = $$(".jp");
          for (let i = 0; i < jpCheckboxes.length; i++) {
            const checkbox = jpCheckboxes[i];
            if (checkbox) {
              const isChecked = await api.storageGet(`jp:${today}`, false);
              checkbox.checked = isChecked;
            }
          }

          // Charger la note du jour
          const $note = $("#note");
          if ($note) {
            const noteContent = await api.storageGet(`note:${today}`, "");
            $note.value = noteContent;
          }

          // Charger les cases Du øƒÅ æ al-Mayyit si vendredi
          if (isFriday(moment())) {
            await loadMayyitCases(today);
          }

          console.log('[Journal] Donn√©es charg√©es avec succ√®s');
        } catch (error) {
          console.error("[Journal] Erreur lors du chargement:", error);
        }
      }

      async function loadMayyitCases(today) {
        const api = window.storageAPI;
        if (!api) return;

        const prayers = ['Fajr', 'Zuhr', 'Asr', 'Maghrib', 'Isha'];
        for (const prayer of prayers) {
          const checkbox = $(`#mayyit-${prayer.toLowerCase()}`);
          if (checkbox) {
            const isChecked = await api.storageGet(`mayyit:${today}:${prayer}`, false);
            checkbox.checked = isChecked;
          }
        }
      }

      function setupJournalEventListeners() {
        // Event listeners pour le tasbih
        const $plus = $("#tasbih-plus");
        const $minus = $("#tasbih-minus");
        const $count = $("#tasbih-count");

        if ($plus) {
          $plus.addEventListener("click", async () => {
            count++;
            if ($count) $count.textContent = count;
            const api = window.storageAPI;
            if (api) await api.storageSet("tasbihCount", count);
          });
        }

        if ($minus) {
          $minus.addEventListener("click", async () => {
            if (count > 0) count--;
            if ($count) $count.textContent = count;
            const api = window.storageAPI;
            if (api) await api.storageSet("tasbihCount", count);
          });
        }

        // Event listeners pour les cases de pri√®res
        $$(".jp").forEach((checkbox) => {
          if (checkbox) {
            checkbox.addEventListener("change", async () => {
              const api = window.storageAPI;
              if (api) {
                const today = moment().format("YYYY-MM-DD");
                await api.storageSet(`jp:${today}`, checkbox.checked);
              }
            });
          }
        });

        // Event listener pour la note
        const $note = $("#note");
        if ($note) {
          $note.addEventListener("input", async () => {
            const api = window.storageAPI;
            if (api) {
              const today = moment().format("YYYY-MM-DD");
              await api.storageSet(`note:${today}`, $note.value);
            }
          });
        }

        // Event listeners pour les cases Du øƒÅ æ al-Mayyit
        const prayers = ['fajr', 'zuhr', 'asr', 'maghrib', 'isha'];
        prayers.forEach((prayer) => {
          const checkbox = $(`#mayyit-${prayer}`);
          if (checkbox) {
            checkbox.addEventListener("change", async () => {
              const api = window.storageAPI;
              if (api) {
                const today = moment().format("YYYY-MM-DD");
                const prayerName = prayer.charAt(0).toUpperCase() + prayer.slice(1);
                await api.storageSet(`mayyit:${today}:${prayerName}`, checkbox.checked);
              }
            });
          }
        });
      }

      async function initJournal() {
        if (journalInitialized) return;

        if (!window.storageAPI) {
          setTimeout(initJournal, 100);
          return;
        }

        // Ajouter la section Du øƒÅ æ al-Mayyit si vendredi
        if (isFriday(moment())) {
          addMayyitSection();
        }

        setupJournalEventListeners();
        await loadJournalData();
        journalInitialized = true;
      }

      function addMayyitSection() {
        const journalContainer = $('#journal-container');
        if (!journalContainer || $("#journal-zikr")) return;

        const mayyitHtml = `
          <div class="card" id="journal-zikr">
            <h3 class="text-lg font-semibold mb-3">Du øƒÅ æ al-Mayyit (Vendredi)</h3>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <label class="flex items-center gap-2">
                <input type="checkbox" class="form-checkbox" id="mayyit-fajr">
                <span>Fajr</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" class="form-checkbox" id="mayyit-zuhr">
                <span>·∫íuhr</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" class="form-checkbox" id="mayyit-asr">
                <span> øA·π£r</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" class="form-checkbox" id="mayyit-maghrib">
                <span>Maghrib</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" class="form-checkbox" id="mayyit-isha">
                <span> øIshƒÅ æ</span>
              </label>
            </div>
          </div>
        `;

        journalContainer.insertAdjacentHTML('beforeend', mayyitHtml);
      }

      // Initialisation au chargement de la page et √† l'ouverture de l'onglet
      document.addEventListener("DOMContentLoaded", initJournal);


      // Fonctions pour le Focus du jour (Zikrs personnalis√©s)
      const ZIKR_CONFIG = {
        "fajr": { label: "Tawhid", when: "apr√®s Fajr" },
        "shuruq": { label: "Istighfar", when: "√† Shuruq" },
        "dhuhr": { label: "Sal√¢t  øala n-Nab√Æ", when: "apr√®s Dhuhr" },
        "asr": { label: "Tasbih", when: "apr√®s Asr" },
        "maghrib": { label: "Du øƒÅ æ", when: "apr√®s Maghrib" },
        "isha": { label: "Tasbih", when: "apr√®s Isha" },
        "night": { label: "Salawat", when: "avant de dormir" }
      };

      function todayTasks(now) {
        const day = now.day(); // 0=Lun, 5=Ven, 6=Sam
        const tasks = [];

        if (day !== 5) { // Si ce n'est pas vendredi
          tasks.push({ key: "fajr", ...ZIKR_CONFIG["fajr"] });
          tasks.push({ key: "shuruq", ...ZIKR_CONFIG["shuruq"] });
          tasks.push({ key: "dhuhr", ...ZIKR_CONFIG["dhuhr"] });
          tasks.push({ key: "asr", ...ZIKR_CONFIG["asr"] });
          tasks.push({ key: "maghrib", ...ZIKR_CONFIG["maghrib"] });
          tasks.push({ key: "isha", ...ZIKR_CONFIG["isha"] });
        } else { // Si c'est vendredi
          tasks.push({ key: "fajr", ...ZIKR_CONFIG["fajr"] });
          tasks.push({ key: "shuruq", ...ZIKR_CONFIG["shuruq"] });
          tasks.push({ key: "dhuhr", ...ZIKR_CONFIG["dhuhr"] });
          tasks.push({ key: "asr", ...ZIKR_CONFIG["asr"] });
          tasks.push({ key: "maghrib", ...ZIKR_CONFIG["maghrib"] });
          tasks.push({ key: "isha", ...ZIKR_CONFIG["isha"] });
        }

        tasks.push({ key: "night", ...ZIKR_CONFIG["night"] });
        return tasks;
      }

      async function isDone(key, today) {
        const api = window.storageAPI;
        if (!api) return false;
        return await api.storageGet(`zikrDone:${today}:${key}`, false);
      }

      async function markDone(key, today) {
        const api = window.storageAPI;
        if (!api) return;
        await api.storageSet(`zikrDone:${today}:${key}`, true);
      }


      // Fonctions pour les lectures
      let currentLectureData = null;
      let currentLecturePage = 0;
      const ITEMS_PER_PAGE = 20;

      // Charger et afficher le contenu des lectures
      async function loadLecture(type) {
        try {
          const response = await fetch(`./data/${type}.json`);
          if (!response.ok) throw new Error(`Erreur ${response.status}`);

          currentLectureData = await response.json();
          currentLecturePage = 0;

          renderLectureContent(type);

        } catch (error) {
          console.error('[Lectures] Erreur de chargement:', error);
          $("#lect-content").innerHTML = `
            <div class="text-red-600 p-4 rounded-lg bg-red-50">
              <p><strong>Erreur de chargement</strong></p>
              <p>Impossible de charger le contenu "${type}". V√©rifiez que le fichier existe.</p>
            </div>
          `;
        }
      }

      // Rendre le contenu selon le type
      function renderLectureContent(type) {
        if (!currentLectureData) return;

        const contentEl = $("#lect-content");

        if (type === 'kahf') {
          renderKahfContent(contentEl);
        } else if (type === 'special') {
          renderSpecialContent(contentEl);
        }
      }

      // Rendre la sourate Al-Kahf avec pagination
      function renderKahfContent(contentEl) {
        const data = currentLectureData;
        const startIndex = currentLecturePage * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, data.length);
        const pageData = data.slice(startIndex, endIndex);

        let html = `
          <div class="mb-6">
            <h3 class="text-2xl font-semibold mb-2 title">Sourate Al-Kahf (La Caverne)</h3>
            <p class="text-slate-600 mb-4">Versets ${startIndex + 1} √† ${endIndex} sur ${data.length}</p>
          </div>
          <div class="space-y-6">
        `;

        pageData.forEach(verse => {
          html += `
            <div class="border-l-4 border-emerald-200 pl-4 py-3">
              <div class="flex items-start gap-2 mb-2">
                <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-100 text-emerald-800 text-sm font-bold rounded-full">${verse.ayah}</span>
              </div>
              <div class="text-right text-2xl leading-loose font-arabic mb-3" style="font-family: 'Amiri', serif;">${verse.ar}</div>
              <div class="text-slate-700 leading-relaxed">${verse.fr}</div>
            </div>
          `;
        });

        html += '</div>';

        // Boutons de pagination si n√©cessaire
        if (data.length > ITEMS_PER_PAGE) {
          const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);
          html += `
            <div class="flex justify-center gap-3 mt-8">
              <button id="prev-page" class="px-4 py-2 rounded-lg border ${currentLecturePage === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'}">
                Pr√©c√©dent
              </button>
              <span class="px-4 py-2 text-slate-600">
                Page ${currentLecturePage + 1} sur ${totalPages}
              </span>
              <button id="next-page" class="px-4 py-2 rounded-lg border ${currentLecturePage >= totalPages - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'}">
                Suivant
              </button>
            </div>
          `;
        }

        contentEl.innerHTML = html;

        // Brancher les √©v√©nements de pagination
        setupPagination();
      }

      // Rendre le contenu sp√©cial quotidien
      function renderSpecialContent(contentEl) {
        const data = currentLectureData;

        let html = `
          <div class="mb-6">
            <h3 class="text-2xl font-semibold mb-2 title">Lecture Spirituelle Quotidienne</h3>
            <p class="text-slate-600 mb-4">${data.description}</p>
          </div>

          <div class="bg-emerald-50 p-6 rounded-xl mb-6">
            <h4 class="font-semibold mb-3 text-emerald-800">Invocation du jour</h4>
            <div class="text-right text-xl leading-loose font-arabic mb-3" style="font-family: 'Amiri', serif;">${data.dua}</div>
            <div class="text-slate-700">${data.dua_fr}</div>
          </div>

          <div class="mb-6">
            <h4 class="font-semibold mb-3">Sourates recommand√©es</h4>
            <div class="grid sm:grid-cols-2 gap-2">
        `;

        data.sourates.forEach((sourate, index) => {
          html += `
            <div class="p-3 bg-slate-50 rounded-lg text-sm">
              <span class="font-medium">${index + 1}.</span> ${sourate}
            </div>
          `;
        });

        html += `
            </div>
          </div>

          <div class="bg-blue-50 p-6 rounded-xl">
            <h4 class="font-semibold mb-3 text-blue-800">Conseils de lecture</h4>
            <ul class="space-y-2">
        `;

        data.recommendations.forEach(rec => {
          html += `<li class="flex items-start gap-2"><span class="text-blue-600 mt-1">‚Ä¢</span><span class="text-slate-700">${rec}</span></li>`;
        });

        html += `
            </ul>
          </div>
        `;

        contentEl.innerHTML = html;
      }

      // Configuration des boutons de pagination
      function setupPagination() {
        const prevBtn = $("#prev-page");
        const nextBtn = $("#next-page");

        if (prevBtn) {
          prevBtn.addEventListener("click", () => {
            if (currentLecturePage > 0) {
              currentLecturePage--;
              renderLectureContent('kahf');
            }
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener("click", () => {
            const totalPages = Math.ceil(currentLectureData.length / ITEMS_PER_PAGE);
            if (currentLecturePage < totalPages - 1) {
              currentLecturePage++;
              renderLectureContent('kahf');
            }
          });
        }
      }

      // Gestion des boutons de s√©lection des lectures
      $$('[data-lect]').forEach(btn => {
        btn.addEventListener('click', () => {
          // Mise √† jour visuelle des boutons
          $$('[data-lect]').forEach(b => b.setAttribute('aria-pressed', 'false'));
          btn.setAttribute('aria-pressed', 'true');

          // Chargement du contenu
          const lectureType = btn.dataset.lect;
          loadLecture(lectureType);
        });
      });

      // Chargement initial de Al-Kahf
      loadLecture('kahf');

      // Fonction de rendu du programme d√©taill√©
      let programmeLoaded = false;
      async function renderProgramme() {
        if (programmeLoaded) return;

        try {
          const response = await fetch('./data/programme.json');
          if (!response.ok) throw new Error(`Erreur ${response.status}`);

          const data = await response.json();

          // 1. Programme semaine (jour par jour)
          const weekContainer = $("#prog-week");
          let weekHtml = '';

          const jours = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
          const joursNoms = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

          jours.forEach((jour, index) => {
            const jourData = data.semaine[jour];
            weekHtml += `
              <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-3 text-lg">${joursNoms[index]}</h3>
                <div class="space-y-3">
                  <div>
                    <h4 class="font-medium text-slate-700 mb-1">üåô Nuit</h4>
                    <p class="text-sm text-slate-600">${jourData.nuit}</p>
                  </div>
                  <div>
                    <h4 class="font-medium text-slate-700 mb-1">‚òÄÔ∏è Jour</h4>
                    <p class="text-sm text-slate-600">${jourData.jour}</p>
                  </div>
                </div>
              </div>
            `;
          });
          weekContainer.innerHTML = weekHtml;

          // 2. Zikrs personnels
          const zikrsContainer = $("#prog-zikrs");
          let zikrsHtml = '';

          data.zikrPersonnels.forEach(zikr => {
            zikrsHtml += `
              <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-2">${zikr.nom}</h3>
                <div class="text-sm text-slate-600">
                  <p><strong>Fr√©quence :</strong> ${zikr.frequence}</p>
                  <p><strong>R√©p√©titions :</strong> ${zikr.repetitions}√ó</p>
                </div>
              </div>
            `;
          });
          zikrsContainer.innerHTML = zikrsHtml;

          // 3. Formules
          const formulesContainer = $("#prog-formules");
          let formulesHtml = '';

          Object.values(data.formules).forEach(formule => {
            formulesHtml += `
              <div class="border-l-4 border-emerald-200 pl-6 py-4">
                <h3 class="font-semibold mb-2">${formule.titre}</h3>
                <p class="text-sm text-slate-600 mb-3">${formule.contexte}</p>
                <div class="text-right text-xl leading-loose font-arabic bg-slate-50 p-4 rounded-lg" style="font-family: 'Amiri', serif;">
                  ${formule.ar}
                </div>
              </div>
            `;
          });
          formulesContainer.innerHTML = formulesHtml;

          programmeLoaded = true;
          console.log('[Programme] Contenu charg√© avec succ√®s');

        } catch (error) {
          console.error('[Programme] Erreur de chargement:', error);
          $("#prog-week").innerHTML = '<p class="text-red-600">Erreur de chargement du programme</p>';
        }
      }

      // Fonction de rendu de la retraite
      let retraiteLoaded = false;
      async function renderRetraite() {
        if (retraiteLoaded) return;

        try {
          const response = await fetch('./data/retraite.json');
          if (!response.ok) throw new Error(`Erreur ${response.status}`);

          const data = await response.json();

          // 1. Grille quotidienne
          const gridContainer = $("#retreat-grid");
          let gridHtml = `
            <table class="w-full border-collapse border border-slate-300">
              <thead>
                <tr class="bg-slate-100">
                  <th class="border border-slate-300 p-3 text-left font-semibold">Cr√©neaux</th>
                  <th class="border border-slate-300 p-3 text-left font-semibold">Activit√©s Constantes</th>
                </tr>
              </thead>
              <tbody>
          `;

          data.grilleQuotidienne.forEach(item => {
            gridHtml += `
              <tr>
                <td class="border border-slate-300 p-3 font-medium">${item.creneau}</td>
                <td class="border border-slate-300 p-3">${item.constant}</td>
              </tr>
            `;
          });

          gridHtml += '</tbody></table>';
          gridContainer.innerHTML = gridHtml;

          // 2. Accents par semaine
          const weeksContainer = $("#retreat-weeks");
          let weeksHtml = '';

          Object.entries(data.themes).forEach(([semaine, theme]) => {
            const accent = data.accentsHebdo[semaine];
            weeksHtml += `
              <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-2">Semaine ${semaine}</h3>
                <h4 class="text-emerald-600 font-medium mb-3">${theme}</h4>

                <div class="space-y-3">
                  <div>
                    <h5 class="font-medium text-sm mb-1">Notes :</h5>
                    <ul class="text-sm text-slate-600 space-y-1">
                      ${accent.notes.map(note => `<li>‚Ä¢ ${note}</li>`).join('')}
                    </ul>
                  </div>

                  <div>
                    <h5 class="font-medium text-sm mb-1">Exemples :</h5>
                    <ul class="text-sm text-slate-600 space-y-1">
                      ${accent.exemples.map(exemple => `<li>‚Ä¢ ${exemple}</li>`).join('')}
                    </ul>
                  </div>
                </div>
              </div>
            `;
          });
          weeksContainer.innerHTML = weeksHtml;

          // 3. Planning annuel all√©g√©
          const annualContainer = $("#retreat-annual");
          const annual = data.annuelAllege;
          let annualHtml = `
            <div class="grid md:grid-cols-2 gap-6">
              <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-3">Routine Hebdomadaire</h3>
                <div class="space-y-3">
                  <div>
                    <h4 class="font-medium text-slate-700 mb-1">üåÖ Matin</h4>
                    <p class="text-sm text-slate-600">${annual.semaine.matin}</p>
                  </div>
                  <div>
                    <h4 class="font-medium text-slate-700 mb-1">üåû Midi</h4>
                    <p class="text-sm text-slate-600">${annual.semaine.midi}</p>
                  </div>
                  <div>
                    <h4 class="font-medium text-slate-700 mb-1">üåÜ Soir</h4>
                    <p class="text-sm text-slate-600">${annual.semaine.soir}</p>
                  </div>
                </div>
              </div>

              <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-3">Avant le Sommeil</h3>
                <p class="text-sm text-slate-600">${annual.avantSommeil}</p>
              </div>
            </div>
          `;
          annualContainer.innerHTML = annualHtml;

          retraiteLoaded = true;
          console.log('[Retraite] Contenu charg√© avec succ√®s');

        } catch (error) {
          console.error('[Retraite] Erreur de chargement:', error);
          $("#retreat-grid").innerHTML = '<p class="text-red-600">Erreur de chargement de la retraite</p>';
        }
      }

      // Charger le contenu lors de l'ouverture des onglets
      $$('[data-tab="programme"]')[0].addEventListener("click", renderProgramme);
      $$('[data-tab="retraite"]')[0].addEventListener("click", renderRetraite);
      $$('[data-tab="journal"]')[0].addEventListener("click", initJournal); // Assure l'initialisation si l'onglet Journal est ouvert

      // Ic√¥nes lucide
      window.lucide?.createIcons();


      // Horloge g√©n√©rale et mise √† jour du focus du jour
      function tick() {
        const now = moment();
        $("#clock").textContent = now.format("HH:mm:ss");
        $("#date-greg").textContent = now.format("dddd D MMMM YYYY");
        $("#date-hijri").textContent = now.format("iYYYY/iMM/iDD");

        const next = nextPrayer();
        $("#next-prayer-name").textContent = next.p.name;
        $("#next-prayer-eta").textContent = next.t.format("HH:mm:ss"); // Affiche l'heure exacte de la prochaine pri√®re

        // Mettre √† jour le focus du jour toutes les minutes
        if (now.seconds() === 0) {
          updateFocusDuJour();
        }
      }
      setInterval(tick, 1000);
      tick();

      // Initialisation du focus du jour au chargement
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(updateFocusDuJour, 500); // Attendre que storageAPI soit pr√™t
      });

    </script>
  </body>
</html>