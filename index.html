<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compagnon Spirituel</title>

    <!-- Styles & Librairies externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/fr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.1.2/moment-hijri.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Polices & PWA -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Lato:wght@300;400;700&family=Orbitron:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#fdfaf6" />

    <!-- CSS uniquement -->
    <style>
      :root {
        --bg: #fdfaf6;
        --card: #ffffff;
        --ink: #3b2f2f;
        --muted: #a58f86;
        --brand: #ea5b3c;
        --ring: #10b981;
      }
      html,
      body {
        height: 100%;
        background: var(--bg);
        font-family:
          "Lato",
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          "Helvetica Neue",
          Arial,
          "Noto Sans",
          "Liberation Sans",
          sans-serif;
      }
      .title {
        font-family: "Amiri", serif;
      }
      .clock {
        font-family: "Orbitron", monospace;
        letter-spacing: 0.06em;
      }
      .card {
        background: var(--card);
        border-radius: 22px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
        padding: 1.25rem;
      }
      .tab-btn[aria-selected="true"] {
        background: #fff;
        color: #0f172a;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      }
      .badge {
        background: #eef2ff;
        color: #3730a3;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 700;
      }
      .qibla-rose {
        width: 220px;
        height: 220px;
        border-radius: 50%;
        border: 8px solid #e5e7eb;
        position: relative;
        margin: auto;
      }
      .qibla-rose::after {
        content: "N";
        position: absolute;
        top: -28px;
        left: 50%;
        transform: translateX(-50%);
        color: #6b7280;
        font-weight: 700;
      }
      .qibla-arrow {
        position: absolute;
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 80px solid var(--ring);
        left: 50%;
        top: 50%;
        transform-origin: 50% 90%;
        transform: translate(-50%, -80%) rotate(0deg);
        filter: drop-shadow(0 6px 10px rgba(16, 185, 129, 0.35));
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>

  <body class="text-slate-800">
    <!-- Header -->
    <header class="max-w-5xl mx-auto px-4 py-10">
      <h1 class="title text-center text-5xl sm:text-6xl text-slate-800">
        Compagnon Spirituel
      </h1>
      <p class="text-center text-[var(--brand)] mt-2">
        Votre guide spirituel quotidien
      </p>

      <!-- Horloge & Dates -->
      <div class="mt-8 card max-w-xl mx-auto text-center">
        <div id="clock" class="clock text-5xl sm:text-6xl text-slate-700">
          --:--:--
        </div>
        <div class="mt-5">
          <div id="date-greg" class="font-semibold text-sky-600">—</div>
          <div id="date-hijri" class="text-slate-500">—</div>
        </div>
        <div class="mt-4">
          <span id="mode-badge" class="badge">Planning Annuel</span>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="sticky top-0 z-20 bg-[var(--bg)] border-y border-slate-200/70">
      <div class="max-w-5xl mx-auto px-4">
        <ul class="flex flex-wrap gap-2 sm:gap-3 py-3">
          <!-- 7 onglets -->
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="accueil"
              aria-selected="true"
            >
              Accueil
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="programme"
            >
              Programme
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="lectures"
            >
              Lectures
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="retraite"
            >
              Retraite
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="journal"
            >
              Journal
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="mois"
            >
              Mois
            </button>
          </li>
          <li>
            <button
              class="tab-btn px-3 py-2 rounded-xl text-sm"
              data-tab="qibla"
            >
              Qibla
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Pages -->
    <main class="max-w-5xl mx-auto px-4 py-8 space-y-10">
      <!-- Accueil -->
      <section data-page="accueil">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Prochaine prière -->
          <div class="card">
            <h2 class="title text-2xl mb-3">Prochaine prière</h2>
            <div class="flex items-center gap-4">
              <div>
                <div class="text-sm text-slate-500">Ville : Bobo-Dioulasso</div>
                <div class="mt-1 text-lg font-semibold">
                  <span id="next-prayer-name">—</span> dans
                  <span id="next-prayer-eta">--:--:--</span>
                </div>
              </div>
            </div>
            <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
              <div class="p-3 rounded-xl border" id="p-Fajr">
                Fajr : <b id="t-Fajr">—</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Shuruq">
                Shuruq : <b id="t-Shuruq">—</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Dhuhr">
                Dhuhr : <b id="t-Dhuhr">—</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Asr">
                Asr : <b id="t-Asr">—</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Maghrib">
                Maghrib : <b id="t-Maghrib">—</b>
              </div>
              <div class="p-3 rounded-xl border" id="p-Isha">
                Isha : <b id="t-Isha">—</b>
              </div>
            </div>
          </div>

          <!-- Graphiques -->
          <div class="card">
            <h2 class="title text-2xl mb-3">Suivi hebdomadaire</h2>
            <div class="grid grid-cols-1 gap-6">
              <canvas
                id="chart-rakaa"
                height="150"
                class="bg-white rounded-xl"
              ></canvas>
              <canvas
                id="chart-zikr"
                height="150"
                class="bg-white rounded-xl"
              ></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Programme -->
      <section data-page="programme" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-3">Programme détaillé</h2>
          <p class="text-slate-600">
            Affiche ici les prières surérogatoires, zikrs et formules par jour.
            (Structure prête — on branchera les données ensuite.)
          </p>
        </div>
      </section>

      <!-- Lectures -->
      <section data-page="lectures" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-4">Lectures</h2>
          <div class="flex gap-2 mb-4">
            <button
              class="px-3 py-1.5 rounded-lg border"
              data-lect="kahf"
              aria-pressed="true"
            >
              Sourate Al-Kahf
            </button>
            <button class="px-3 py-1.5 rounded-lg border" data-lect="special">
              Lecture spéciale quotidienne
            </button>
          </div>
          <div id="lect-content" class="prose max-w-none text-[17px] leading-8">
            Choisis une lecture.
          </div>
        </div>
      </section>

      <!-- Retraite -->
      <section data-page="retraite" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-3">Configuration de la Retraite</h2>
          <label class="block text-sm text-slate-600 mb-1"
            >Date de début (4 semaines)</label
          >
          <input
            id="retreat-start"
            type="date"
            class="border rounded-lg px-3 py-2"
          />
          <button
            id="retreat-save"
            class="ml-2 px-3 py-2 rounded-lg bg-emerald-600 text-white"
          >
            Enregistrer
          </button>
          <div id="retreat-msg" class="mt-3 text-slate-600">—</div>
        </div>
      </section>

      <!-- Journal -->
      <section data-page="journal" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-4">Journal quotidien</h2>
          <div class="grid sm:grid-cols-2 gap-6">
            <div>
              <h3 class="font-semibold mb-2">Prières</h3>
              <div class="space-y-2">
                <label class="flex items-center gap-2"
                  ><input type="checkbox" class="jp" value="Fajr" /> Fajr</label
                >
                <label class="flex items-center gap-2"
                  ><input type="checkbox" class="jp" value="Dhuhr" />
                  Dhuhr</label
                >
                <label class="flex items-center gap-2"
                  ><input type="checkbox" class="jp" value="Asr" /> Asr</label
                >
                <label class="flex items-center gap-2"
                  ><input type="checkbox" class="jp" value="Maghrib" />
                  Maghrib</label
                >
                <label class="flex items-center gap-2"
                  ><input type="checkbox" class="jp" value="Isha" /> Isha</label
                >
              </div>

              <h3 class="font-semibold mt-6 mb-2">Tasbih</h3>
              <div class="flex items-center gap-3">
                <button id="tasbih-" class="px-3 py-2 rounded-lg border">
                  -1
                </button>
                <div
                  id="tasbih-val"
                  class="min-w-[3ch] text-center font-semibold"
                >
                  0
                </div>
                <button id="tasbih+" class="px-3 py-2 rounded-lg border">
                  +1
                </button>
              </div>
            </div>

            <div>
              <h3 class="font-semibold mb-2">Notes personnelles</h3>
              <textarea
                id="note"
                rows="7"
                class="w-full rounded-lg border p-3"
                placeholder="Écris ici ce que ton cœur a retenu aujourd’hui…"
              ></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- Mois -->
      <section data-page="mois" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-3">Mois hégirien en cours</h2>
          <div id="mois-info" class="text-slate-600">
            Nom, sens, pratiques recommandées… (structure prête)
          </div>
        </div>
      </section>

      <!-- Qibla -->
      <section data-page="qibla" class="hidden">
        <div class="card">
          <h2 class="title text-2xl mb-4">Direction de la Qibla</h2>
          <div class="qibla-rose">
            <div id="qibla-arrow" class="qibla-arrow" aria-hidden="true"></div>
            <span class="sr-only" id="qibla-angle-label"></span>
          </div>
          <div class="mt-4 flex items-center gap-3">
            <button
              id="btn-geo"
              class="px-3 py-2 rounded-lg bg-slate-800 text-white"
            >
              Utiliser ma position
            </button>
            <div id="qibla-text" class="text-slate-600">
              Par défaut : Bobo-Dioulasso
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-12 pb-10 text-center text-slate-500">
      Compagnon spirituel pour faciliter la pratique quotidienne.
    </footer>

    <!-- 1) Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("sw.js").catch(console.error);
        });
      }
    </script>

    <!-- 2) Bridge: expose window.storageAPI (via bridge.js) -->
    <script type="module" src="./bridge.js"></script>

    <!-- 3) App Controller (horloge, onglets, prières, charts, qibla) -->
    <script type="module">
      // --- Fallback localStorage ---
      if (!window.storageAPI) {
        window.storageAPI = {
          storageGet: async (key, defVal) => {
            try { const v = localStorage.getItem(key); return v == null ? defVal : JSON.parse(v); }
            catch { return defVal; }
          },
          storageSet: async (key, val) => { localStorage.setItem(key, JSON.stringify(val)); return true; },
          storageRemove: async (key) => { localStorage.removeItem(key); return true; },
          storageSubscribe: (key, cb) => {
            const h = (e) => { if (e.key === key) cb(e.newValue ? JSON.parse(e.newValue) : null); };
            window.addEventListener('storage', h); return () => window.removeEventListener('storage', h);
          }
        };
        console.log('[Compagnon] fallback storage ready');
      }
      // -----------------------------

      // util
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => [...r.querySelectorAll(s)];

      // Horloge & Dates
      moment.locale("fr");
      function tickClock() {
        const now = moment();
        $("#clock").textContent = now.format("HH:mm:ss");
        $("#date-greg").textContent = now.format("dddd D MMMM YYYY");
        const hijri = now.clone().format("iD iMMMM iYYYY"); // moment-hijri
        $("#date-hijri").textContent = hijri;
      }
      tickClock();
      setInterval(tickClock, 1000);

      // Onglets
      const pages = $$("section[data-page]");
      const btns = $$(".tab-btn");
      function show(tab) {
        pages.forEach((p) =>
          p.classList.toggle("hidden", p.dataset.page !== tab),
        );
        btns.forEach((b) =>
          b.setAttribute("aria-selected", String(b.dataset.tab === tab)),
        );
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
      btns.forEach((b) =>
        b.addEventListener("click", () => show(b.dataset.tab)),
      );
      show("accueil");

      // Mode (badge) depuis storage
      async function refreshMode() {
        const api = window.storageAPI;
        if (!api) return;
        const start = await api.storageGet("retreatStart", null);
        if (!start) {
          $("#mode-badge").textContent = "Planning Annuel";
          return;
        }
        const d0 = moment(start),
          diff = moment().diff(d0, "weeks");
        $("#mode-badge").textContent =
          `Mode Retraite – Semaine ${Math.min(diff + 1, 4)}`;
      }
      refreshMode();

      // Retraite: set date
      $("#retreat-save").addEventListener("click", async () => {
        const v = $("#retreat-start").value;
        if (!v) return;
        await window.storageAPI?.storageSet("retreatStart", v);
        $("#retreat-msg").textContent =
          `Retraite enregistrée du ${moment(v).format("DD/MM/YYYY")} pour 4 semaines.`;
        refreshMode();
      });

      // Horaires de prière (Bobo-Dioulasso – placeholders statiques pour la démo)
      const PRAYERS = [
        { name: "Fajr", time: "05:00" },
        { name: "Shuruq", time: "06:15" },
        { name: "Dhuhr", time: "12:30" },
        { name: "Asr", time: "15:45" },
        { name: "Maghrib", time: "18:30" },
        { name: "Isha", time: "19:45" },
      ];
      for (const p of PRAYERS) {
        $("#t-" + p.name).textContent = p.time;
      }
      console.log('Chart version:', window.Chart?.version);

      // Charts - créés UNE seule fois
      const ctxRakaa = document.getElementById("chart-rakaa")?.getContext("2d");
      const ctxZikr = document.getElementById("chart-zikr")?.getContext("2d");

      if (window.Chart && ctxRakaa && ctxZikr) {
        new Chart(ctxRakaa, {
          type: "bar",
          data: {
            labels: ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"],
            datasets: [
              { label: "Rakʿât (jour+nuit)", data: [6, 8, 10, 4, 12, 8, 6] },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });

        new Chart(ctxZikr, {
          type: "doughnut",
          data: {
            labels: ["Tawhid", "Istighfar", "Salât ʿala n-Nabî", "Autres"],
            datasets: [{ data: [40, 30, 20, 10] }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "60%",
          },
        });
      } else {
        console.warn("Chart.js non chargé ou canvas introuvable.");
      }

      // Helper pour créer une date "aujourd'hui" à partir de HH:mm
      function todayAt(hhmm) {
        const [H, M] = hhmm.split(":").map(Number);
        return moment().clone().hours(H).minutes(M).seconds(0).milliseconds(0);
      }

      function nextPrayer() {
        const now = moment();
        for (const p of PRAYERS) {
          const t = todayAt(p.time);
          if (now.isBefore(t)) return { p, t };
        }
        // sinon Fajr de demain
        return { p: PRAYERS[0], t: todayAt(PRAYERS[0].time).add(1, "day") };
      }

      function updateCountdown() {
        const { p, t } = nextPrayer();
        $("#next-prayer-name").textContent = p.name;

        const diff = moment.duration(t.diff(moment()));
        const hh = String(Math.floor(diff.asHours())).padStart(2, "0");
        const mm = String(diff.minutes()).padStart(2, "0");
        const ss = String(diff.seconds()).padStart(2, "0");
        $("#next-prayer-eta").textContent = `${hh}:${mm}:${ss}`;

        // surbrillance
        PRAYERS.forEach((x) => {
          const el = $("#p-" + x.name);
          el.classList.toggle("ring", x.name === p.name);
          el.classList.toggle("ring-emerald-500", x.name === p.name);
          el.classList.toggle("ring-offset-2", x.name === p.name);
        });
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);

      // Journal: persistance locale unifiée
      let journalLoaded = false;
      async function loadJournal() {
        const api = window.storageAPI;
        if (!api || journalLoaded) return;

        try {
          // 1. Tasbih - charger et brancher les boutons
          let tasbihValue = await api.storageGet("tasbihCount", 0);
          $("#tasbih-val").textContent = tasbihValue;

          // Nettoyer les anciens event listeners si ils existent
          const btnPlus = $("#tasbih+");
          const btnMinus = $("#tasbih-");
          btnPlus.replaceWith(btnPlus.cloneNode(true));
          btnMinus.replaceWith(btnMinus.cloneNode(true));

          $("#tasbih+").addEventListener("click", async () => {
            tasbihValue = (tasbihValue | 0) + 1;
            $("#tasbih-val").textContent = tasbihValue;
            await api.storageSet("tasbihCount", tasbihValue);
          });

          $("#tasbih-").addEventListener("click", async () => {
            tasbihValue = Math.max(0, (tasbihValue | 0) - 1);
            $("#tasbih-val").textContent = tasbihValue;
            await api.storageSet("tasbihCount", tasbihValue);
          });

          // 2. Note du jour - charger et brancher l'input
          const today = moment().format("YYYY-MM-DD");
          const noteKey = `note:${today}`;
          const savedNote = await api.storageGet(noteKey, "");
          const noteEl = $("#note");
          noteEl.value = savedNote || "";

          // Nettoyer l'ancien listener
          noteEl.replaceWith(noteEl.cloneNode(true));
          $("#note").addEventListener("input", async (e) => {
            await api.storageSet(noteKey, e.target.value);
          });

          // 3. Cases à cocher prières - charger et brancher par date
          const prayersKey = `jp:${today}`;
          const savedPrayers = await api.storageGet(prayersKey, {});

          $$(".jp").forEach((checkbox) => {
            // Nettoyer l'ancien listener
            checkbox.replaceWith(checkbox.cloneNode(true));
          });

          $$(".jp").forEach((checkbox) => {
            checkbox.checked = Boolean(savedPrayers[checkbox.value]);
            checkbox.addEventListener("change", async () => {
              savedPrayers[checkbox.value] = checkbox.checked;
              await api.storageSet(prayersKey, savedPrayers);
            });
          });

          journalLoaded = true;
          console.log('[Journal] Données chargées pour', today);
        } catch (error) {
          console.error('[Journal] Erreur lors du chargement:', error);
        }
      }

      // Charger à l'ouverture de l'onglet Journal
      $$('[data-tab="journal"]')[0].addEventListener("click", loadJournal);

      // Qibla (Kaaba)
      const MECCA = { lat: 21.4225, lon: 39.8262 };
      const DEFAULT = { lat: 11.186, lon: -4.29 }; // Bobo-Dioulasso
      function toRad(x) {
        return (x * Math.PI) / 180;
      }
      function toDeg(x) {
        return (x * 180) / Math.PI;
      }
      function bearing(from, to) {
        const φ1 = toRad(from.lat),
          φ2 = toRad(to.lat),
          Δλ = toRad(to.lon - from.lon);
        const y = Math.sin(Δλ) * Math.cos(φ2);
        const x =
          Math.cos(φ1) * Math.sin(φ2) -
          Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
        return (toDeg(Math.atan2(y, x)) + 360) % 360;
      }
      function setQibla(pos, label = "Par défaut : Bobo-Dioulasso") {
        const ang = bearing(pos, MECCA);
        $("#qibla-arrow").style.transform =
          `translate(-50%,-80%) rotate(${ang}deg)`;
        $("#qibla-angle-label").textContent = `Qibla ${ang.toFixed(1)}°`;
        $("#qibla-text").textContent = label;
      }
      setQibla(DEFAULT);
      $("#btn-geo").addEventListener("click", () => {
        if (!navigator.geolocation) {
          alert("Géolocalisation non disponible.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (p) =>
            setQibla(
              { lat: p.coords.latitude, lon: p.coords.longitude },
              "Position actuelle",
            ),
          (_) => alert("Accès à la position refusé."),
        );
      });

      // Icônes lucide
      window.lucide?.createIcons();
    </script>
  </body>
</html>